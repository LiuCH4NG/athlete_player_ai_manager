# 完整系统调用流程图

```mermaid
graph TB
    subgraph "客户端层"
        Client1[Web前端]
        Client2[HTTP客户端]
        Client3[移动端APP]
    end

    subgraph "API网关层 (FastAPI)"
        Router[路由分发器]
        Auth[依赖注入]
        CRUD_API[CRUD接口层]
        Chat_API[聊天接口层]
    end

    subgraph "业务逻辑层"
        CRUD_Layer[CRUD业务层<br/>app/crud.py]
        Schema_Validation[Schema验证<br/>app/schemas.py]
    end

    subgraph "AI服务层"
        AI_Agent[AI代理<br/>create_react_agent]
        LLM_Service[LLM服务<br/>Ollama/OpenAI]
        MCP_Client[MCP客户端<br/>MultiServerMCPClient]
        Tools[MCP工具列表]
    end

    subgraph "数据访问层"
        ORM[SQLAlchemy ORM<br/>app/models.py]
        Session[AsyncSession<br/>数据库连接池]
    end

    subgraph "数据存储层"
        SQLite[(SQLite数据库<br/>athlete.db)]
    end

    %% 系统启动路径
    Startup[main.py启动] --> Router
    Router -->|初始化| ORM
    ORM -->|创建表| SQLite

    %% 客户端请求路径
    Client1 -->|HTTP| Router
    Client2 -->|HTTP| Router
    Client3 -->|HTTP| Router

    %% API路由分发
    Router --> CRUD_API
    Router --> Chat_API

    %% CRUD API调用路径
    CRUD_API --> CRUD_Layer
    CRUD_API --> Schema_Validation
    CRUD_Layer --> Session
    Session --> ORM
    ORM --> SQLite

    %% AI聊天调用路径
    Chat_API --> AI_Agent
    AI_Agent --> LLM_Service
    AI_Agent --> MCP_Client
    MCP_Client --> Tools
    Tools --> CRUD_API
    CRUD_API --> SQLite

    %% 数据返回路径
    SQLite --> ORM
    ORM --> Session
    Session --> CRUD_Layer
    CRUD_Layer --> Schema_Validation
    Schema_Validation --> CRUD_API
    CRUD_API --> Client1

    MCP_Client --> LLM_Service
    LLM_Service --> AI_Agent
    AI_Agent --> Chat_API
    Chat_API --> Client2
```

## 系统架构分层

```mermaid
graph LR
    subgraph L1 [客户端层]
        A1[Web前端]
        A2[API客户端]
        A3[移动应用]
    end

    subgraph L2 [API网关层]
        B1[FastAPI路由]
        B2[依赖注入]
        B3[Schema验证]
    end

    subgraph L3 [业务逻辑层]
        C1[CRUD业务逻辑]
        C2[AI代理逻辑]
        C3[MCP工具逻辑]
    end

    subgraph L4 [数据访问层]
        D1[SQLAlchemy ORM]
        D2[AsyncSession]
        D3[连接池管理]
    end

    subgraph L5 [数据存储层]
        E1[SQLite数据库]
        E2[Athlete表]
    end

    A1 --> B1
    A2 --> B1
    A3 --> B1

    B1 --> C1
    B1 --> C2

    C1 --> D1
    C2 --> D1

    D1 --> E1
    E1 --> E2
```

## 核心调用流程详解

### 1. 系统启动流程
```mermaid
sequenceDiagram
    participant main.py
    participant FastAPI
    participant ORM
    participant SQLite

    main.py->>FastAPI: uvicorn.run(app.main:app)
    FastAPI->>ORM: create_async_engine
    ORM->>ORM: create_all_tables
    ORM->>SQLite: CREATE TABLE athletes
    SQLite-->>ORM: 表创建成功
    ORM-->>FastAPI: 初始化完成
    FastAPI-->>main.py: 服务器启动
```

### 2. CRUD操作流程
```mermaid
sequenceDiagram
    participant Client
    participant FastAPI
    participant CRUD
    participant DB

    Client->>FastAPI: POST /athletes
    FastAPI->>CRUD: create_athlete
    CRUD->>DB: INSERT INTO athletes
    DB-->>CRUD: 返回新记录
    CRUD-->>FastAPI: 返回Athlete对象
    FastAPI-->>Client: HTTP 201
```

### 3. AI聊天流程 (核心链路)
```mermaid
sequenceDiagram
    participant Client
    participant FastAPI
    participant LLM
    participant MCP
    participant DB

    Client->>FastAPI: GET /chat?message=...
    FastAPI->>LLM: agent.ainvoke
    LLM->>FastAPI: 调用search_athletes
    FastAPI->>DB: 查询数据库
    DB-->>FastAPI: 返回结果
    FastAPI->>LLM: 返回工具结果
    LLM-->>FastAPI: 生成回复
    FastAPI-->>Client: 返回自然语言
```

## 技术栈总览

| 层级 | 技术/框架 | 职责 |
|------|----------|------|
| 客户端层 | HTML/JS, HTTP客户端 | 用户交互 |
| API网关 | FastAPI | 路由分发, 请求处理 |
| 业务层 | Python | 业务逻辑 |
| AI服务 | LangChain, LangGraph | AI推理, 工具调用 |
| 数据访问 | SQLAlchemy | ORM映射 |
| 数据存储 | SQLite | 持久化存储 |

## 端口与服务

| 服务 | 端口 | 描述 |
|------|------|------|
| FastAPI服务器 | 8001 | 主API服务 |
| MCP端点 | 8001/mcp | 工具服务 |
| Ollama | 11434 | LLM服务 (可选) |
| OpenAI兼容 | 1234/v1 | LLM服务 (可选) |

## 关键特性

### 1. 软删除机制
- 所有DELETE操作标记而非物理删除
- 查询自动过滤 `is_deleted=false` 记录

### 2. AI智能查询
- 自然语言理解
- 自动工具选择
- 动态参数提取

### 3. 异步处理
- AsyncSQLAlchemy 异步数据库
- FastAPI 异步Web框架
- 非阻塞I/O操作

### 4. 模块化设计
- 清晰的层次分离
- 可插拔的LLM提供商
- 灵活的查询条件构建
