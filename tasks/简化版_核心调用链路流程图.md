# 简化版核心调用链路流程图

```mermaid
sequenceDiagram
    participant User as 用户
    participant Backend as FastAPI后端
    participant LLM as 大语言模型
    participant MCP as MCP协议
    participant DB as 数据库

    User->>Backend: 查询："找一下库存少于10个的注射器"
    Backend->>LLM: 分析意图
    LLM->>LLM: 识别为库存查询任务<br/>提取参数：category=注射器, max_stock=10
    LLM->>MCP: 调用search_medical_supplies工具
    MCP->>DB: 执行SQL：WHERE category LIKE '注射器' AND stock_quantity <= 10
    DB-->>MCP: 返回耗材列表
    MCP-->>LLM: 返回查询结果
    LLM->>LLM: 格式化为自然语言
    LLM-->>Backend: 生成回复文本
    Backend-->>User: "找到1个库存少于10个的注射器：医用手套..."
```

## 更简洁的文字版流程

```
用户查询
    ↓
FastAPI /chat
    ↓
LLM理解意图
    ↓
MCP调用API
    ↓
SQLite查询
    ↓
LLM格式化
    ↓
返回结果
```

## 超简化版本

```mermaid
graph LR
    A[用户查询] --> B[FastAPI]
    B --> C[LLM分析]
    C --> D[MCP工具]
    D --> E[数据库查询]
    E --> F[LLM格式化]
    F --> G[返回结果]
```

## 关键数据流

```
自然语言 → LLM解析 → 结构化查询 → SQL执行 → 结构化数据 → 自然语言回复
```

**示例**：
- 输入："找一下库存少于10个的注射器"
- 参数：`{category: "注射器", max_stock: 10}`
- SQL：`SELECT * FROM medical_supplies WHERE category ILIKE '%注射器%' AND stock_quantity <= 10`
- 输出："找到1个库存少于10个的注射器：医用手套（实际为库存5个）..."
