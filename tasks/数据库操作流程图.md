# 数据库操作流程图

```mermaid
graph TD
    A[数据库初始化] --> B[创建SQLAlchemy异步引擎<br/>create_async_engine]
    B --> C[配置数据库URL<br/>sqlite+aiosqlite:///./athlete.db]
    C --> D[创建AsyncSession工厂<br/>sessionmaker]
    D --> E[应用启动时创建所有表<br/>models.Base.metadata.create_all]

    E --> F[依赖注入: get_db]
    F --> G[创建AsyncSession实例<br/>AsyncSessionLocal]

    G --> H{CRUD操作}

    %% 创建操作
    H -->|CREATE| I1[create_athlete]
    I1 --> I2[创建模型实例<br/>models.Athlete]
    I2 --> I3[db.adddb_athlete]
    I3 --> I4[异步提交<br/>await db.commit]
    I4 --> I5[刷新实例<br/>await db.refresh]
    I5 --> I6[返回Athlete对象]

    %% 读取操作
    H -->|READ 单个| J1[get_athlete]
    J1 --> J2[构建SELECT查询<br/>selectAthlete filterid]
    J2 --> J3[添加过滤条件<br/>is_deleted=false]
    J3 --> J4[执行查询<br/>await db.execute]
    J4 --> J5[获取结果<br/>scalars.first]
    J5 --> J6{找到记录?}
    J6 -->|是| J7[返回Athlete对象]
    J6 -->|否| J8[返回None]

    H -->|READ 列表| K1[get_athletes]
    K1 --> K2[构建基础查询<br/>selectAthlete]
    K2 --> K3[添加过滤<br/>is_deleted=false]
    K3 --> K4[分页参数<br/>OFFSET LIMIT]
    K4 --> K5[执行查询]
    K5 --> K6[获取全部结果<br/>scalars.all]
    K6 --> K7[返回Athlete列表]

    %% 更新操作
    H -->|UPDATE| L1[update_athlete]
    L1 --> L2[查询目标记录<br/>id and is_deleted=false]
    L2 --> L3{记录存在?}
    L3 -->|是| L4[获取update_data<br/>athlete.model_dump]
    L4 --> L5[遍历字段<br/>setattr]
    L5 --> L6[提交事务<br/>db.commit]
    L6 --> L7[刷新对象<br/>db.refresh]
    L7 --> L8[返回更新后对象]
    L3 -->|否| L9[返回None]

    %% 删除操作
    H -->|DELETE| M1[delete_athlete]
    M1 --> M2[查询目标记录<br/>id and is_deleted=false]
    M2 --> M3{记录存在?}
    M3 -->|是| M4[设置软删除标记<br/>is_deleted=true]
    M4 --> M5[设置删除时间<br/>deleted_at=now]
    M5 --> M6[提交事务<br/>db.commit]
    M6 --> M7[刷新对象<br/>db.refresh]
    M7 --> M8[返回对象]
    M3 -->|否| M9[返回None]

    %% 搜索操作
    H -->|SEARCH| N1[search_athletes]
    N1 --> N2[构建基础查询<br/>is_deleted=false]
    N2 --> N3{搜索参数}
    N3 -->|name| N4[添加条件<br/>name ILIKE]
    N3 -->|sport_event| N5[添加条件<br/>sport_event ILIKE]
    N3 -->|hometown| N6[添加条件<br/>hometown ILIKE]
    N3 -->|min_age| N7[添加范围<br/>age >= min_age]
    N3 -->|max_age| N8[添加范围<br/>age <= max_age]
    N3 -->|min_height| N9[添加范围<br/>height >= min_height]
    N3 -->|max_height| N10[添加范围<br/>height <= max_height]
    N3 -->|min_weight| N11[添加范围<br/>weight >= min_weight]
    N3 -->|max_weight| N12[添加范围<br/>weight <= max_weight]
    N4 --> N13[应用分页<br/>OFFSET LIMIT]
    N5 --> N13
    N6 --> N13
    N7 --> N13
    N8 --> N13
    N9 --> N13
    N10 --> N13
    N11 --> N13
    N12 --> N13
    N13 --> N14[执行查询<br/>db.execute]
    N14 --> N15[获取结果<br/>scalars.all]
    N15 --> N16[返回Athlete列表]

    I6 --> O1[会话自动关闭]
    J7 --> O1
    J8 --> O1
    K7 --> O1
    L8 --> O1
    M8 --> O1
    N16 --> O1
    O1 --> O2[连接返回连接池]
```

## 数据库模型结构

```mermaid
erDiagram
    ATHLETES {
        Integer id PK
        String name
        Float height
        Float weight
        String description
        DateTime created_at
        DateTime updated_at
        DateTime deleted_at
        Boolean is_deleted
        String sport_event
        Integer age
        String hometown
        String remarks
    }
```

## 数据库操作最佳实践

### 1. 异步会话管理
```python
async def get_db():
    async with AsyncSessionLocal() as db:
        yield db
```

### 2. 事务处理
- **CREATE/UPDATE/DELETE**: 必须调用 `await db.commit()`
- **READ**: 不需要提交
- **错误处理**: 异常自动回滚

### 3. 查询优化
- **过滤未删除记录**: 所有查询添加 `is_deleted=false`
- **索引字段**: id, name 已建索引
- **分页**: 使用 OFFSET/LIMIT

### 4. 软删除机制
```sql
-- 查询时自动过滤
SELECT * FROM athletes WHERE is_deleted = false;

-- 删除时标记
UPDATE athletes SET is_deleted = true WHERE id = ?;
```

### 5. 搜索特性
- **模糊匹配**: ilike 实现不区分大小写搜索
- **范围查询**: 支持 min/max 范围过滤
- **多字段**: 可同时在多个字段搜索
